<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gelato Club – Kiosk Convalide</title>
  <style>
:root{
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color-scheme: light;
}
body{
  margin:0;
  background:#ffffff;
  color:#111827;
}
header{
  position: sticky;
  top:0;
  z-index:10;
  background: rgba(255,255,255,0.92);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid rgba(17,24,39,0.08);
  padding: 10px 12px 8px;
}
.wrap{
  max-width: 720px;
  margin: 0 auto;
}
.brandbox{
  display:flex;
  flex-direction: column;
  align-items:center;
  justify-content:center;
  gap: 8px;
  padding: 2px 0 8px;
}
.brandbox img{
  width: 56px;
  height: 56px;
  object-fit: contain;
  border-radius: 14px;
  box-shadow: 0 10px 28px rgba(17,24,39,0.10);
  background: #fff;
}
.kiosk{
  font-weight: 900;
  letter-spacing: 0.2px;
  font-size: 20px;
  line-height: 1.05;
}
.subline{
  margin-top: 2px;
  font-size: 12px;
  color: rgba(17,24,39,0.65);
}
.row{
  display:flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items:center;
  justify-content:center;
}
.pill{
  padding: 8px 10px;
  border-radius: 999px;
  background: rgba(17,24,39,0.04);
  border: 1px solid rgba(17,24,39,0.08);
  font-size: 13px;
}
.pill strong{ font-weight: 900; }
.tabs{
  display:flex;
  gap:8px;
  margin-top:10px;
}
.tab{
  flex:1;
  padding: 10px 12px;
  border-radius: 14px;
  text-align:center;
  cursor:pointer;
  user-select:none;
  background: rgba(17,24,39,0.04);
  border: 1px solid rgba(17,24,39,0.08);
  font-weight: 800;
}
.tab.active{
  background:#111827;
  color:#fff;
  border-color:#111827;
}
main{
  padding: 12px;
}
.grid{
  display:grid;
  grid-template-columns: 1fr;
  gap: 12px;
  max-width: 720px;
  margin: 0 auto;
}
.card{
  border-radius: 18px;
  padding: 14px;
  background:#ffffff;
  border: 1px solid rgba(17,24,39,0.08);
  box-shadow: 0 10px 30px rgba(17,24,39,0.06);
}
.title{
  font-size: 18px;
  font-weight: 900;
  margin-bottom: 6px;
}
.sub{
  font-size: 14px;
  color: rgba(17,24,39,0.70);
}
.meta{
  margin-top: 6px;
  font-size: 12px;
  color: rgba(17,24,39,0.55);
}
.btns{
  display:flex;
  gap: 10px;
  margin-top: 12px;
}
button{
  padding: 14px 12px;
  border-radius: 16px;
  border: 0;
  cursor:pointer;
  font-weight: 900;
}
button:disabled{ opacity: 0.55; cursor: default; }
.ok{ background:#16a34a; color:#fff; }
.no{ background:#ef4444; color:#fff; }
.ghost{
  background: rgba(17,24,39,0.04);
  color:#111827;
  border: 1px solid rgba(17,24,39,0.10);
}
.blink{ animation: blinkBorder 1s infinite; }
@keyframes blinkBorder{
  0%,100%{ border-color: rgba(220,38,38,0.25); box-shadow: 0 0 0 rgba(0,0,0,0); }
  50%{ border-color: rgba(220,38,38,0.95); box-shadow: 0 0 0 3px rgba(220,38,38,0.10); }
}
50%{ box-shadow: 0 14px 36px rgba(17,24,39,0.10); transform: translateY(-1px); }
}

.login{ max-width: 520px; margin: 24px auto; padding: 0 12px; }
.field{ display:flex; flex-direction:column; gap:6px; margin: 10px 0; }
label{ font-size: 13px; color: rgba(17,24,39,0.70); font-weight: 700; }
input{
  padding: 12px;
  border-radius: 14px;
  border: 1px solid rgba(17,24,39,0.12);
  background: rgba(17,24,39,0.03);
  color:#111827;
  font-size: 16px;
}
.err{ margin-top: 10px; color:#b91c1c; white-space: pre-wrap; }
.muted{ color: rgba(17,24,39,0.55); font-size: 12px; }

/* Toast */
.toast{
  position: fixed;
  left: 50%;
  bottom: 18px;
  transform: translateX(-50%);
  width: min(560px, 92vw);
  border-radius: 20px;
  background: rgba(255,255,255,0.96);
  border: 1px solid rgba(17,24,39,0.12);
  box-shadow: 0 16px 50px rgba(17,24,39,0.16);
  padding: 14px 14px 12px;
  display:none;
}
.toast.show{ display:block; animation: toastIn 180ms ease-out forwards; }
@keyframes toastIn{ from{ opacity:0; transform: translateX(-50%) translateY(10px) scale(0.98);} to{ opacity:1; transform: translateX(-50%) translateY(0) scale(1);} }
.toastRow{ display:flex; gap:12px; align-items:center; }
.badge{
  width: 38px; height: 38px;
  border-radius: 14px;
  display:flex; align-items:center; justify-content:center;
  font-weight: 1000;
  font-size: 20px;
}
.badge.ok{ background: rgba(22,163,74,0.12); color:#16a34a; }
.badge.no{ background: rgba(239,68,68,0.12); color:#ef4444; }
.toastTitle{ font-weight: 1000; font-size: 17px; }
.toastSub{ margin-top: 3px; color: rgba(17,24,39,0.65); font-size: 13px; }
.toastHint{ margin-top: 10px; color: rgba(17,24,39,0.45); font-size: 12px; }

/* Portrait tweaks */
@media (max-width: 480px){
  .brandbox img{ width: 52px; height: 52px; }
  .kiosk{ font-size: 19px; }
  .tab{ padding: 10px; }
  button{ padding: 16px 12px; }
}
  
/* Toast overlay */
.overlay{
  position: fixed;
  inset: 0;
  display: grid;
  place-items: start center;
  padding-top: 90px;
  pointer-events: none;
  opacity: 0;
  transition: opacity .18s ease;
}
.overlay.show{ opacity: 1; }
.toast{
  pointer-events: none;
  display: flex;
  gap: 10px;
  align-items: center;
  background: #ffffff;
  border: 1px solid rgba(17,24,39,0.12);
  box-shadow: 0 16px 40px rgba(17,24,39,0.12);
  border-radius: 14px;
  padding: 12px 14px;
  transform: translateY(-6px);
  transition: transform .18s ease;
}
.overlay.show .toast{ transform: translateY(0); }
.badge{
  width: 34px;
  height: 34px;
  border-radius: 10px;
  display: grid;
  place-items: center;
  font-weight: 900;
  color: #fff;
  flex: 0 0 auto;
}
.badge.ok{ background:#16a34a; }
.badge.no{ background:#dc2626; }
.toastTitle{ font-weight: 900; font-size: 14px; line-height: 1.1; }
.toastSub{ opacity: .75; font-size: 12px; margin-top: 2px; }

.toastRow{ display:flex; gap:10px; align-items:center; }
</style>
</head>
<body>
  <header>
  <div class="wrap"><div class="brandbox">
      <img src="logo.png" alt="Logo Gelateria" onerror="this.style.display='none'">
      <div class="brandtitle">
        <div class="kiosk">Kiosk</div>
        <div class="subline">Gelateria L’Altromare · Convalide rapide</div>
      </div>
    </div>
    <div class="row">
      <div class="pill">Promo approvate oggi: <strong id="cPromo">–</strong></div>
      <div class="pill">Premi approvati oggi: <strong id="cRewards">–</strong></div>
      <div class="pill">Aggiornamento: <strong id="lastUpd">–</strong></div>
      <button class="ghost" id="btnRefresh" style="flex:0 0 auto; padding:10px 12px;">Aggiorna</button>
      <button class="ghost" id="btnLogout" style="flex:0 0 auto; padding:10px 12px; display:none;">Logout</button>
    </div>
    <div class="tabs" id="tabs" style="display:none;">
      <div class="tab active" data-tab="promo">Promo</div>
      <div class="tab" data-tab="rewards">Premi tessera</div>
    </div>
  </div>
</header>

  <main>
    <div id="loginBox" class="login" style="display:none;">
      <div class="card">
        <div class="title">Login staff</div>
        <div class="muted">Usa l’account staff (Supabase Auth). La sessione resta sul dispositivo finché fai logout.</div>
        <div class="field">
          <label>Email</label>
          <input id="email" type="email" autocomplete="username" placeholder="staff@..." />
        </div>
        <div class="field">
          <label>Password</label>
          <input id="password" type="password" autocomplete="current-password" placeholder="••••••••" />
        </div>
        <div class="btns">
          <button class="ok" id="btnLogin">Entra</button>
        </div>
        <div class="err" id="loginErr"></div>
      </div>
    </div>

    <div id="appBox" style="display:none;">
      <div class="grid" id="list"></div>
      <div class="muted" id="empty" style="display:none; margin-top:10px;">Nessuna richiesta in attesa.</div>
    </div>
  </main>

  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // === CONFIG: incolla i tuoi dati ===
    const SUPABASE_URL = "https://cbgwfngseoppybsbbwwo.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNiZ3dmbmdzZW9wcHlic2Jid3dvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NTk4NDYsImV4cCI6MjA3NTQzNTg0Nn0.5U_4SNDZ18YA7PHY7dH3vZItGp-_XzeQxS1IMAuBQEs";

    
    if (!window.supabase || !window.supabase.createClient) {
      alert("Errore: libreria Supabase non caricata. Controlla connessione internet o blocchi di rete.");
    }

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        storageKey: "gc_kiosk_session_v1",
        storage: window.localStorage,
      },
    });

    const el = (id) => document.getElementById(id);

    let currentTab = "promo";
    let pollTimer = null;

    function setLastUpd() {
      const d = new Date();
      el("lastUpd").textContent = d.toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit", second: "2-digit" }

    // Toast popup (OK / X)
    let toastTimer = null;
    function showToast(kind, title, subtitle) {
      const overlay = document.getElementById("overlay");
      const badge = document.getElementById("toastBadge");
      const tTitle = document.getElementById("toastTitle");
      const tSub = document.getElementById("toastSub");
      if (!overlay || !badge || !tTitle || !tSub) return;

      // kind: "ok" | "no"
      badge.className = "badge " + (kind === "ok" ? "ok" : "no");
      badge.textContent = (kind === "ok") ? "✓" : "✕";
      tTitle.textContent = title || "";
      tSub.textContent = subtitle || "";
      overlay.classList.add("show");

      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        overlay.classList.remove("show");
      }, 650);
    }
);
    }

    async function loadCounters() {
      const { data, error } = await sb.from("kiosk_daily_counters").select("*").limit(1).maybeSingle();
      if (!error && data) {
        el("cPromo").textContent = data.promo_approved_today ?? 0;
        el("cRewards").textContent = data.rewards_approved_today ?? 0;
      }
    }

    function renderList(items, kind) {
      const list = el("list");
      list.innerHTML = "";

      el("empty").style.display = items.length ? "none" : "block";

      for (const x of items) {
        const card = document.createElement("div");
        card.className = "card blink"; // lampeggia finché è in lista pending

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = (kind === "promo") ? x.promo_title : x.reward_title;

        const sub = document.createElement("div");
        sub.className = "sub";
        sub.textContent = x.customer_label || "Ospite";

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = `Codice: ${x.code || "—"} · Stato: ${x.status} · ${new Date(x.created_at).toLocaleString("it-IT")}`;

        const btns = document.createElement("div");
        btns.className = "btns";

        const bOk = document.createElement("button");
        bOk.className = "ok";
        bOk.textContent = "Convalida";

        const bNo = document.createElement("button");
        bNo.className = "no";
        bNo.textContent = "Annulla";

        bOk.onclick = async () => {
          bOk.disabled = true; bNo.disabled = true;
          const ok = await approve(kind, x.id);
          if (!ok) { bOk.disabled = false; bNo.disabled = false; return; }
          await refreshAll();
        };

        bNo.onclick = async () => {
          bOk.disabled = true; bNo.disabled = true;
          const ok = await reject(kind, x.id);
          if (!ok) { bOk.disabled = false; bNo.disabled = false; return; }
          await refreshAll();
        };

        btns.appendChild(bOk);
        btns.appendChild(bNo);

        card.appendChild(title);
        card.appendChild(sub);
        card.appendChild(meta);
        card.appendChild(btns);

        list.appendChild(card);
      }
    }

    async function loadQueue(kind) {
      if (kind === "promo") {
        const { data, error } = await sb.from("kiosk_pending_promos").select("*");
        if (error) { alert("Errore promo: " + error.message); return []; }

        // Filtro anti-spazzatura: non mostra promo waiting troppo vecchie o già scadute
        const now = new Date();
        const minDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000); // 30 giorni
        const rows = (data || []).filter(r => {
          try {
            const created = new Date(r.created_at);
            if (created < minDate) return false;
            if (r.expires_at) {
              const exp = new Date(r.expires_at);
              if (!isNaN(exp.getTime()) && exp <= now) return false;
            }
            return true;
          } catch {
            return true;
          }
        });

        return rows;
      } else {
        const { data, error } = await sb.from("kiosk_pending_rewards").select("*");
        if (error) { alert("Errore premi: " + error.message); return []; }
        return data || [];
      }
    }

    async function approve(kind, id) {
      if (kind === "promo") {
        const { error } = await sb.from("redemptions")
          .update({ status: "approved" })
          .eq("id", id)
          .eq("status", "waiting");
        if (error) { alert("Convalida promo fallita: " + error.message); return false; }
        showToast("ok","Promo convalidata", "");
        return true;
      } else {
        const { error } = await sb.from("loyalty_reward_redemptions")
          .update({ status: "approved", approved_at: new Date().toISOString() })
          .eq("id", id)
          .in("status", ["waiting","pending"]);
        if (error) { alert("Convalida premio fallita: " + error.message); return false; }
        showToast("ok","Premio convalidato", "");
        return true;
      }
    }

    async function reject(kind, id) {
      if (kind === "promo") {
        const { error } = await sb.from("redemptions")
          .update({ status: "canceled" })
          .eq("id", id)
          .eq("status", "waiting");
        if (error) { alert("Annulla promo fallito: " + error.message); return false; }
        showToast("no","Promo annullata", "");
        return true;
      } else {
        const { error } = await sb.from("loyalty_reward_redemptions")
          .update({ status: "canceled" })
          .eq("id", id)
          .in("status", ["waiting","pending"]);
        if (error) { alert("Annulla premio fallito: " + error.message); return false; }
        showToast("no","Premio annullato", "");
        return true;
      }
    }

    async function refreshAll() {
      await loadCounters();
      const items = await loadQueue(currentTab);
      renderList(items, currentTab);
      setLastUpd();
    }

    function setTab(tab) {
      currentTab = tab;
      document.querySelectorAll(".tab").forEach(t => {
        t.classList.toggle("active", t.dataset.tab === tab);
      });
      refreshAll();
    }

    function startPolling() {
      stopPolling();
      pollTimer = setInterval(refreshAll, 2000);
    }
    function stopPolling() {
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = null;
    }

    async function showAppOrLogin() {
      const { data } = await sb.auth.getSession();
      const session = data?.session;

      if (!session) {
        el("loginBox").style.display = "block";
        el("appBox").style.display = "none";
        el("tabs").style.display = "none";
        el("btnLogout").style.display = "none";
        stopPolling();
        return;
      }

      // (Opzionale) controllo staff: se la SELECT su profiles è bloccata da RLS,
      // non blocchiamo il kiosk (ci penseranno le policy UPDATE a proteggere le azioni).
      // Se invece riusciamo a leggere profiles, richiediamo is_staff=true.
      const uid = session.user.id;
      let prof = null;
      try {
        const res = await sb.from("profiles").select("is_staff,email").eq("id", uid).maybeSingle();
        if (!res.error) prof = res.data;
      } catch (_) {}

      if (prof && prof.is_staff === false) {
        await sb.auth.signOut();
        el("loginErr").textContent = "Accesso negato: account non staff.";
        el("loginBox").style.display = "block";
        return;
      }

      el("loginBox").style.display = "none";
      el("appBox").style.display = "block";
      el("tabs").style.display = "flex";
      el("btnLogout").style.display = "inline-block";

      await refreshAll();
      startPolling();
    }

    // UI handlers
    document.addEventListener("click", (e) => {
      const t = e.target.closest(".tab");
      if (t) setTab(t.dataset.tab);
    });

    el("btnRefresh").onclick = refreshAll;

    el("btnLogout").onclick = async () => {
      await sb.auth.signOut();
      await showAppOrLogin();
    };

    el("btnLogin").onclick = async () => {
      el("loginErr").textContent = "";
      const email = el("email").value.trim();
      const password = el("password").value;
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if (error) { el("loginErr").textContent = error.message; return; }
      await showAppOrLogin();
    };

    // init
    sb.auth.onAuthStateChange(() => showAppOrLogin());
    showAppOrLogin();
  </script>

  <div class="overlay" id="overlay">
    <div class="toast" role="status" aria-live="polite">
      <div class="toastRow">
        <div class="badge ok" id="toastBadge"></div>
        <div>
          <div class="toastTitle" id="toastTitle">—</div>
          <div class="toastSub" id="toastSub">—</div>
          <div class="toastHint">Ok: si chiude da solo</div>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
