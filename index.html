<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gelato Club Kiosk</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{
  margin:0;
  font-family:Inter,system-ui;
  background:#0f172a;
  color:white;
}
.header{
  padding:20px;
  background:#111827;
  position:sticky;
  top:0;
  z-index:10;
  border-bottom:1px solid #1f2937;
}
.title{
  font-size:28px;
  font-weight:700;
}
.stats{
  margin-top:8px;
  font-size:16px;
  opacity:0.8;
}
.container{
  padding:20px;
}
.card{
  background:#1e293b;
  padding:20px;
  border-radius:16px;
  margin-bottom:20px;
  box-shadow:0 10px 25px rgba(0,0,0,0.4);
  border:2px solid transparent;
  transition:0.3s;
}
.waiting{
  animation:blink 1.2s infinite;
}
@keyframes blink{
  0%{border-color:#22c55e;}
  50%{border-color:#3b82f6;}
  100%{border-color:#22c55e;}
}
.promo{
  font-size:22px;
  font-weight:600;
}
.user{
  margin-top:8px;
  font-size:16px;
  opacity:0.8;
}
.time{
  margin-top:4px;
  font-size:14px;
  opacity:0.6;
}
.buttons{
  margin-top:15px;
  display:flex;
  gap:10px;
}
button{
  flex:1;
  padding:14px;
  font-size:16px;
  border-radius:10px;
  border:none;
  cursor:pointer;
  font-weight:600;
}
.approve{
  background:#22c55e;
  color:black;
}
.cancel{
  background:#ef4444;
  color:white;
}
.login{
  display:flex;
  flex-direction:column;
  height:100vh;
  justify-content:center;
  align-items:center;
  gap:10px;
}
input{
  padding:12px;
  font-size:16px;
  border-radius:8px;
  border:none;
  width:250px;
}
</style>
</head>
<body>

<div id="app"></div>

<script>
const sb = window.supabase.createClient(
  "https://cbgwfngseoppybsbbwwo.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNiZ3dmbmdzZW9wcHlic2Jid3dvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NTk4NDYsImV4cCI6MjA3NTQzNTg0Nn0.5U_4SNDZ18YA7PHY7dH3vZItGp-_XzeQxS1IMAuBQEs"
);

let promotions = [];
let totalCount = parseInt(localStorage.getItem("kiosk_total")) || 0;

async function loadPromotions(){
  const res = await fetch("YOUR_SUPABASE_URL/storage/v1/object/public/config/promotions.json");
  promotions = await res.json();
}

function getPromoTitle(id){
  const p = promotions.find(x=>x.id===id);
  return p ? p.title : id;
}

function formatTime(ts){
  return new Date(ts).toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"});
}

function todayCount(data){
  const today = new Date().toDateString();
  return data.filter(x=>new Date(x.created_at).toDateString()===today).length;
}

function renderLogin(){
  document.getElementById("app").innerHTML=`
  <div class="login">
    <h2>Login Staff</h2>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Accedi</button>
  </div>`;
}

async function login(){
  const email=document.getElementById("email").value;
  const password=document.getElementById("password").value;
  const {error}=await sb.auth.signInWithPassword({email,password});
  if(error){ alert("Login fallito"); return;}
  checkStaff();
}

async function checkStaff(){
  const {data:user}=await sb.auth.getUser();
  if(!user?.user?.email) return renderLogin();

  const {data}=await supabase
    .from("staff_emails")
    .select("*")
    .eq("email",user.user.email)
    .single();

  if(!data){
    alert("Non autorizzato");
    await sb.auth.signOut();
    renderLogin();
  }else{
    startDashboard();
  }
}

async function startDashboard(){
  await loadPromotions();
  setInterval(loadRedemptions,2000);
  loadRedemptions();
}

async function loadRedemptions(){
  const {data}=await supabase
    .from("redemptions")
    .select("*")
    .eq("status","waiting")
    .order("created_at",{ascending:false});

  renderDashboard(data||[]);
}

function renderDashboard(data){
  const today=todayCount(data);
  document.getElementById("app").innerHTML=`
  <div class="header">
    <div class="title">Convalide in attesa</div>
    <div class="stats">
      In attesa: ${data.length} |
      Oggi: ${today} |
      Totale: ${totalCount}
    </div>
  </div>
  <div class="container">
    ${data.map(r=>`
      <div class="card waiting">
        <div class="promo">${getPromoTitle(r.promo_id)}</div>
        <div class="user">${r.user_email||"OSPITE"}</div>
        <div class="time">${formatTime(r.created_at)}</div>
        <div class="buttons">
          <button class="approve" onclick="approve('${r.id}')">CONVALIDA</button>
          <button class="cancel" onclick="cancel('${r.id}')">ANNULLA</button>
        </div>
      </div>
    `).join("")}
  </div>`;
}

async function approve(id){
  await sb.from("redemptions")
    .update({status:"approved"})
    .eq("id",id);

  totalCount++;
  localStorage.setItem("kiosk_total",totalCount);
  loadRedemptions();
}

async function cancel(id){
  await sb.from("redemptions")
    .update({status:"canceled"})
    .eq("id",id);
  loadRedemptions();
}

sb.auth.getSession().then(({data})=>{
  if(data.session){
    checkStaff();
  }else{
    renderLogin();
  }
});
</script>
</body>
</html>
